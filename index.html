

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KasirKu - Sistem Kasir Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/escpos-encoder@0.6.2/encoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qz-tray/qz-tray.js"></script>



    <!-- Firebase App (core) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCx-gmf73_opjxB2GT9HkTyUaJLuT--tMQ",
    authDomain: "kasir-7e48c.firebaseapp.com",
    databaseURL: "https://kasir-7e48c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kasir-7e48c",
    storageBucket: "kasir-7e48c.appspot.com",
    messagingSenderId: "63349901955",
    appId: "1:63349901955:web:50a31befe202e88bee29b6",
    measurementId: "G-NGGL6YBM69"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Simpan ke window agar bisa dipakai di file HTML
  window.db = db;
window.ref = ref;
window.push = push;
window.set = set;
window.get = get;
window.child = child;
window.onValue = onValue;
window.remove = remove;
window.update = update;
</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card-modern {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .card-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .btn-modern {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success-modern {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #065f46;
            border: none;
        }
        
        .btn-danger-modern {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #991b1b;
            border: none;
        }
        
        .input-modern {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-modern:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .nav-item {
            position: relative;
            padding: 12px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        .pulse-dot {
            position: relative;
        }
        
        .pulse-dot::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 1;
            }
        }
        
        .table-modern {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .table-modern th {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            padding: 16px;
        }
        
        .table-modern td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .modal-modern {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-cash-register text-xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold">KasirKu</h1>
                    <div class="pulse-dot ml-2"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="glass-effect px-4 py-2 rounded-lg">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="currentTime" class="font-medium"></span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-md">
        <div class="container mx-auto px-6 py-2">
            <div class="flex flex-wrap gap-2">
                <button onclick="showSection('kasir')" class="nav-item active">
                    <i class="fas fa-cash-register mr-2"></i>Kasir
                </button>
                <button onclick="showSection('produk')" class="nav-item">
                    <i class="fas fa-boxes mr-2"></i>Produk
                </button>
                <button onclick="showSection('pelanggan')" class="nav-item">
                    <i class="fas fa-users mr-2"></i>Pelanggan
                </button>
                <button onclick="showSection('laporan')" class="nav-item">
                    <i class="fas fa-chart-bar mr-2"></i>Laporan
                </button>
                <button onclick="showSection('kulakan')" class="nav-item">
                <i class="fas fa-truck mr-2"></i> Kulakan
                </button>
                <button onclick="showSection('casbon')" class="nav-item">
                <i class="fas fa-hand-holding-usd mr-2"></i> Casbon
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Section Kasir -->
        <div id="section-kasir" class="section fade-in">
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
                <!-- Form Transaksi -->
                <div class="xl:col-span-3 space-y-6">
                    <div class="card-modern p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i class="fas fa-shopping-cart mr-3 text-indigo-600"></i>
                            Transaksi Penjualan
                        </h2>
                        
                        <!-- Pilih Pelanggan -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pilih Pelanggan</label>
                            <select id="selectPelanggan" class="input-modern w-full">
                                <option value="umum">Pelanggan Umum</option>
                            </select>
                        </div>

                        <!-- Cari Produk -->
                        <div class="mb-6">
                            <input type="text" id="searchProdukKasir" placeholder="Ketik nama produk..." class="input-modern w-full pl-12">
                            <button onclick="openScanner()" class="mt-3 btn-modern btn-primary-modern">
  <i class="fas fa-barcode mr-2"></i> Scan Produk
</button>
<!-- Tempat hasil pencarian ditampilkan -->
<div id="searchSuggestions" class="absolute z-50 w-full bg-white border rounded-lg mt-1 hidden shadow-lg max-h-60 overflow-y-auto"></div>

                    </div>

                    <!-- Keranjang Belanja -->
                    <div class="card-modern p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-shopping-basket mr-3 text-green-600"></i>
                            Keranjang Belanja
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-modern">
                                <thead>
                                    <tr>
                                        <th class="text-left">Produk</th>
                                        <th class="text-center">Satuan</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-right">Harga</th>
                                        <th class="text-right">Total</th>
                                        <th class="text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="keranjangTable">
                                    <tr>
                                        <td colspan="6" class="text-center py-12 text-gray-500">
                                            <i class="fas fa-shopping-cart text-4xl mb-4 opacity-50"></i>
                                            <p>Keranjang masih kosong</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Total dan Checkout -->
                        <div class="border-t pt-6 mt-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="text-2xl font-bold text-gray-800">
                                    Total: Rp <span id="totalBelanja">0</span>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="clearKeranjang()" class="btn-modern btn-danger-modern">
                                        <i class="fas fa-trash mr-2"></i>Kosongkan
                                    </button>
                                    <button onclick="prosesCheckout()" class="btn-modern btn-success-modern">
                                        <i class="fas fa-credit-card mr-2"></i>Checkout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="space-y-6">
                    <div class="stat-card">
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold">Total Transaksi</h3>
                                <i class="fas fa-receipt text-2xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold" id="totalTransaksiHari">0</div>
                            <div class="text-sm opacity-75">Hari ini</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-gray-800">Total Pendapatan</h3>
                                <i class="fas fa-money-bill-wave text-2xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">Rp <span id="totalPendapatanHari">0</span></div>
                            <div class="text-sm opacity-75 text-gray-700">Hari ini</div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
<!-- Modal Struk -->
<div id="modalStruk" class="fixed inset-0 hidden bg-white p-6 z-50 overflow-y-auto print:block">
  <div class="max-w-sm mx-auto border p-4 rounded-md shadow-md print:shadow-none">
    <div class="text-center mb-4">
      <h2 class="text-xl font-bold">TOKO POJOK BAHRIYAH</h2>
      <p class="text-sm">Jl. Simpang Tiga Partellon, Jati Jajar Palengaan laok palengaan pamekasan</p>
      <p class="text-xs text-gray-500">--------------------------------------------------------------</p>
    </div>

    <div id="strukIsi" class="text-sm">
      <!-- Struk akan diisi dengan JS -->
    </div>

    <div id="strukButtons" class="mt-6 text-center print:hidden hidden">
      <button onclick="window.print()" class="btn-modern btn-primary-modern w-full mb-2">
        <i class="fas fa-print mr-2"></i>Cetak Struk
      </button>
      <button onclick="tutupStruk()" class="btn-modern btn-danger-modern w-full">
        <i class="fas fa-times mr-2"></i>Tutup
      </button>
        <button onclick="cetakRawBT(transaksi)">üñ®Ô∏è Cetak via RawBT</button>
    </div>
  </div>
</div>
 </div>
</div>
        <!-- Section Produk -->
        <div id="section-produk" class="section hidden fade-in">
            <div class="card-modern p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-boxes mr-3 text-indigo-600"></i>
                        Manajemen Produk
                    </h2>
                </div>
                <div class="mb-4">
  <input type="text" id="searchProdukManajemen" oninput="filterProduk()"
    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
    placeholder="Cari produk berdasarkan nama atau kode...">
</div>
                <!-- Tabel Produk -->
                <div class="overflow-x-auto">
                    <table class="w-full table-modern">
                        <thead>
                            <tr>
                                <th class="text-left">Nama Produk</th>
                                <th class="text-left">Barcode</th>
                                <th class="text-left">Kategori</th>
                                <th class="text-center">Stok</th>
                                <th class="text-right">Harga Umum</th>
                                <th class="text-right">Harga Grosir</th>
                                <th class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="produkTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section Pelanggan -->
        <div id="section-pelanggan" class="section hidden fade-in">
            <div class="card-modern p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-users mr-3 text-indigo-600"></i>
                        Manajemen Pelanggan
                    </h2>
                    <button onclick="showTambahPelanggan()" class="btn-modern btn-primary-modern">
                        <i class="fas fa-user-plus mr-2"></i>Tambah Pelanggan
                    </button>
                </div>
                
                <!-- Tabel Pelanggan -->
                <div class="overflow-x-auto">
                    <table class="w-full table-modern">
                        <thead>
                            <tr>
                                <th class="text-left">Nama Toko</th>
                                <th class="text-left">Nama Pemilik</th>
                                <th class="text-center">Tipe Pelanggan</th>
                                <th class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pelangganTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section Laporan -->
        <div id="section-laporan" class="section hidden fade-in">
            <div class="card-modern p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-indigo-600"></i>
                    Laporan Penjualan
                </h2>
                <!-- Filter Laporan -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Periode</label>
                        <select id="periodeLaporan" class="input-modern w-full">
                            <option value="hari">Hari Ini</option>
                            <option value="minggu">Minggu Ini</option>
                            <option value="bulan">Bulan Ini</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Mulai</label>
                        <input type="date" id="tanggalMulai" class="input-modern w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Tanggal Selesai</label>
                        <input type="date" id="tanggalSelesai" class="input-modern w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Aksi</label>
                        <button onclick="generateLaporan()" class="btn-modern btn-primary-modern w-full">
                            <i class="fas fa-search mr-2"></i>Lihat Laporan
                        </button>
                    </div>
                </div>

                <!-- Ringkasan Laporan -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="stat-card">
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm opacity-75">Total Transaksi</div>
                                <i class="fas fa-receipt text-2xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold" id="laporanTotalTransaksi">0</div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);">
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm opacity-75 text-gray-700">Total Pendapatan</div>
                                <i class="fas fa-money-bill-wave text-2xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold text-gray-800">Rp <span id="laporanTotalPendapatan">0</span></div>
                        </div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);">
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm opacity-75 text-purple-800">Produk Terjual</div>
                                <i class="fas fa-box text-2xl opacity-50"></i>
                            </div>
                            <div class="text-3xl font-bold text-purple-800" id="laporanProdukTerjual">0</div>
                        </div>
                    </div>
                </div>
                    <div class="flex flex-col md:flex-row gap-3 mb-4 w-full">
  <button onclick="exportToExcel()" class="btn-modern btn-success-modern w-full md:w-1/2">
    <i class="fas fa-file-excel mr-2"></i> Export ke Excel
  </button>
  <button onclick="hapusLaporanTerfilter()" class="btn-modern btn-danger-modern w-full md:w-1/2">
    <i class="fas fa-trash-alt mr-2"></i> Hapus Laporan yang Terfilter
  </button>
</div>
                <!-- Detail Transaksi -->
                <div class="overflow-x-auto">
                    <table id="laporanTable" class="w-full table-modern">
  <thead>
    <tr>
      <th class="text-left">Tanggal</th>
      <th class="text-left">Pelanggan</th>
      <th class="text-center">Item</th>
      <th class="text-right">Total</th>
      <th class="text-right">Aksi</th>
    </tr>
  </thead>
  <tbody id="laporanTableBody">
    <!-- Data laporan akan dimasukkan dari JavaScript -->
  </tbody>
</table>
    </div>
      </div>
        </div>
    </main>

    <div id="modalDetailTransaksi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-4 rounded-lg max-w-md w-full shadow-xl">
    <h2 class="text-lg font-bold mb-2">Detail Transaksi</h2>
    <div id="detailIsiProduk" class="space-y-2 max-h-60 overflow-y-auto text-sm">
      <!-- Produk tampil di sini -->
    </div>
    <button onclick="tutupModalDetail()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 w-full">
      Tutup
    </button>
  </div>
</div>

    <div id="section-casbon" class="section hidden fade-in">
  <div class="card-modern p-6">
    <h2 class="text-2xl font-bold mb-6">
      <i class="fas fa-hand-holding-usd mr-2 text-orange-500"></i> Data Casbon Pelanggan
    </h2>
    <div class="overflow-x-auto">
      <table class="w-full table-modern">
        <thead>
  <tr>
    <th>Tanggal</th>
    <th>Pelanggan</th>
    <th>Total</th>
    <th>Sisa</th>
    <th>Status</th>
    <th>Aksi</th> <!-- ‚úÖ tambahkan ini -->
  </tr>
</thead>

        <tbody id="casbonTable">
          <tr><td colspan="5" class="text-center text-gray-400 py-6">Belum ada data casbon</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Edit Casbon -->
<div id="modalEditCasbon" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Edit Casbon</h2>
    <form id="formEditCasbon">
      <input type="hidden" id="editCasbonId">
      <input type="text" id="editNama" class="input-modern mb-3" placeholder="Nama" required>
      <input type="number" id="editTotal" class="input-modern mb-3" placeholder="Total" required>
      <input type="number" id="editCasbonSisa" class="input-modern mb-3" placeholder="Sisa Hutang" required>
      <select id="editStatus" class="input-modern mb-3">
        <option value="Belum Lunas">Belum Lunas</option>
        <option value="Lunas">Lunas</option>
      </select>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeModalEditCasbon()" class="btn-modern">Batal</button>
        <button type="submit" class="btn-modern btn-primary-modern">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Section Kulakan -->
<div id="section-kulakan" class="section hidden fade-in">
  <div class="card-modern p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
      <i class="fas fa-truck mr-3 text-indigo-500"></i> Kulakan Barang
    </h2>

    <form id="formKulakan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
  <!-- BARIS 1 -->
  <div>
    <label for="kulakanNama" class="block text-sm font-semibold text-gray-700 mb-2">Nama Produk</label>
    <input type="text" id="kulakanNama" class="input-modern w-full" placeholder="Contoh: Indomie Goreng" required>
  </div>

  <div>
    <label for="kulakanSupplier" class="block text-sm font-semibold text-gray-700 mb-2">Supplier</label>
    <input type="text" id="kulakanSupplier" class="input-modern w-full" placeholder="Contoh: PT Indofood">
  </div>

<div class="mb-4">
  <label for="kulakanBarcode" class="block text-sm font-semibold text-gray-700 mb-1">
    Barcode Produk
  </label>
  
  <input type="text" id="kulakanBarcode"
    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
    placeholder="Ketik atau tempel barcode produk..." />

  <button type="button" onclick="scanKulakanBarcode()"
    class="mt-2 w-full sm:w-auto px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">
    <i class="fas fa-barcode mr-2"></i> Scan Barcode
  </button>
</div>

  <!-- BARIS 2 -->
  <div>
    <label for="kulakanKategori" class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
    <input type="text" id="kulakanKategori" class="input-modern w-full" placeholder="Contoh: Makanan Instan">
  </div>

  <div>
    <label for="kulakanQty" class="block text-sm font-semibold text-gray-700 mb-2">Jumlah Beli</label>
    <input type="number" id="kulakanQty" class="input-modern w-full" placeholder="Contoh: 5">
  </div>

  <div>
    <label for="kulakanSatuan" class="block text-sm font-semibold text-gray-700 mb-2">Satuan</label>
    <select id="kulakanSatuan" class="input-modern w-full" required>
      <option value="pcs">PCS</option>
      <option value="dus">DUS</option>
      <option value="renteng">RENTENG</option>
    </select>
  </div>

  <!-- BARIS 3 -->
  <div>
    <label for="kulakanHargaKulakan" class="block text-sm font-semibold text-gray-700 mb-2">Harga Kulakan / Satuan</label>
    <input type="number" id="kulakanHargaKulakan" class="input-modern w-full" placeholder="Contoh: 150000" required>
  </div>

  <div>
    <label for="kulakanHargaUmumPcs" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Umum / PCS</label>
    <input type="number" id="kulakanHargaUmumPcs" class="input-modern w-full" placeholder="Contoh: 3000" required>
  </div>
<div>
  <label for="kulakanHargaUmumDus" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Umum / DUS</label>
  <input type="number" id="kulakanHargaUmumDus" class="input-modern w-full" placeholder="Contoh: 30000">
</div>

<div>
  <label for="kulakanHargaUmumRenteng" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Umum / RENTENG</label>
  <input type="number" id="kulakanHargaUmumRenteng" class="input-modern w-full" placeholder="Contoh: 15000">
</div>

  <div>
    <label for="kulakanHargaGrosirPcs" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Grosir / PCS</label>
    <input type="number" id="kulakanHargaGrosirPcs" class="input-modern w-full" placeholder="Contoh: 2800" required>
  </div>

  <div>
  <label for="kulakanHargaGrosirDus" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Grosir / DUS</label>
  <input type="number" id="kulakanHargaGrosirDus" class="input-modern w-full" placeholder="Contoh: 28000">
</div>

<div>
  <label for="kulakanHargaGrosirRenteng" class="block text-sm font-semibold text-gray-700 mb-2">Harga Jual Grosir / RENTENG</label>
  <input type="number" id="kulakanHargaGrosirRenteng" class="input-modern w-full" placeholder="Contoh: 14000">
</div>

  <!-- BARIS 4 -->
  <div>
    <label for="kulakanKonversiDus" class="block text-sm font-semibold text-gray-700 mb-2">1 Dus = ... PCS</label>
    <input type="number" id="kulakanKonversiDus" class="input-modern w-full" value="12">
  </div>

  <div>
    <label for="kulakanKonversiRenteng" class="block text-sm font-semibold text-gray-700 mb-2">1 Renteng = ... PCS</label>
    <input type="number" id="kulakanKonversiRenteng" class="input-modern w-full" value="10">
  </div>

  <div class="w-full my-4">
  <button type="submit" class="btn-modern btn-primary-modern w-full">
    <i class="fas fa-save mr-2"></i> Simpan Kulakan & Produk
  </button>
</div>
</form>

<div class="flex flex-col md:flex-row gap-3 w-full mb-4">
  <button onclick="exportKulakanExcel()" class="btn-modern btn-success-modern w-full md:w-1/2">
    <i class="fas fa-file-excel mr-2"></i> Export Kulakan ke Excel
  </button>
  <button onclick="hapusKulakanTerfilter()" class="btn-modern btn-danger-modern w-full md:w-1/2">
    <i class="fas fa-trash-alt mr-2"></i> Hapus Data Kulakan Terfilter
  </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
  <!-- Tanggal Mulai -->
  <div class="w-full">
    <label for="tanggalMulaiKulakan" class="text-sm font-semibold mb-1 block">Tanggal Mulai</label>
    <input type="date" id="tanggalMulaiKulakan" class="input-modern w-full">
  </div>

  <!-- Tanggal Selesai -->
  <div class="w-full">
    <label for="tanggalSelesaiKulakan" class="text-sm font-semibold mb-1 block">Tanggal Selesai</label>
    <input type="date" id="tanggalSelesaiKulakan" class="input-modern w-full">
  </div>

  <!-- Tombol Filter -->
  <div class="w-full flex items-end">
    <button onclick="filterKulakan()" class="btn-modern btn-primary-modern w-full">
      <i class="fas fa-search mr-2"></i> Filter
    </button>
  </div>
</div>


  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
  <!-- Total Barang Masuk -->
  <div class="w-full p-6 rounded-xl bg-gradient-to-br from-blue-400 to-purple-600 text-white flex justify-between items-center shadow-lg">
    <div>
      <div class="text-base font-semibold">Total Barang Masuk</div>
      <div class="text-4xl font-bold mt-1" id="totalBarangMasuk">0</div>
    </div>
    <i class="fas fa-box-open text-5xl opacity-30"></i>
  </div>

  <!-- Total Harga Kulakan -->
  <div class="w-full p-6 rounded-xl bg-gradient-to-br from-green-300 to-blue-300 text-gray-900 flex justify-between items-center shadow-lg">
    <div>
      <div class="text-base font-semibold">Total Harga Kulakan</div>
      <div class="text-4xl font-bold mt-1" id="totalHargaKulakan">Rp 0</div>
    </div>
    <i class="fas fa-money-bill-wave text-5xl opacity-30"></i>
  </div>
</div>

    <!-- Tabel Kulakan -->
    <div class="overflow-x-auto">
      <table class="w-full table-modern">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Nama</th>
            <th>Supplier</th>
            <th>Qty</th>
            <th>Harga</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="kulakanTable">
          <tr>
            <td colspan="6" class="text-center text-gray-400 py-8">Belum ada data kulakan</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- Modal untuk Form Produk -->
    <div id="modalProduk" class="fixed inset-0 modal-modern hidden flex items-center justify-center p-4 z-50">
        <div class="modal-content p-8 w-full max-w-4xl max-h-screen overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 flex items-center" id="modalProdukTitle">
                <i class="fas fa-box mr-3 text-indigo-600"></i>
                Tambah Produk
            </h3>
            <form id="formProduk" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
  <label class="block text-sm font-semibold text-gray-700 mb-2">Barcode Produk</label>
  <input type="text" id="barcodeProduk" class="input-modern w-full">
  <button type="button" onclick="scanBarcodeProduk()" class="btn-modern btn-primary-modern mt-2">
    <i class="fas fa-barcode mr-1"></i> Scan Barcode
  </button>
</div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Produk</label>
                        <input type="text" id="namaProduk" required class="input-modern w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Kategori</label>
                        <input type="text" id="kategoriProduk" required class="input-modern w-full">
                    </div>
                </div>
                
                <!-- Stok dan Satuan -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Stok (PCS)</label>
                        <input type="number" id="stokProduk" required min="0" class="input-modern w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">1 Dus = ? PCS</label>
                        <input type="number" id="konversiDus" min="1" value="12" class="input-modern w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">1 Renteng = ? PCS</label>
                        <input type="number" id="konversiRenteng" min="1" value="10" class="input-modern w-full">
                    </div>
                </div>

                <!-- Harga untuk Pelanggan Umum -->
                <div class="card-modern p-6 bg-blue-50">
                    <h4 class="font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-users mr-2"></i>
                        Harga untuk Pelanggan Umum
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per PCS</label>
                            <input type="number" id="hargaUmumPcs" required min="0" class="input-modern w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per Dus</label>
                            <input type="number" id="hargaUmumDus" min="0" class="input-modern w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per Renteng</label>
                            <input type="number" id="hargaUmumRenteng" min="0" class="input-modern w-full">
                        </div>
                    </div>
                </div>

                <!-- Harga untuk Pelanggan Grosir -->
                <div class="card-modern p-6 bg-green-50">
                    <h4 class="font-semibold text-green-800 mb-4 flex items-center">
                        <i class="fas fa-store mr-2"></i>
                        Harga untuk Pelanggan Grosir
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per PCS</label>
                            <input type="number" id="hargaGrosirPcs" required min="0" class="input-modern w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per Dus</label>
                            <input type="number" id="hargaGrosirDus" min="0" class="input-modern w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Harga per Renteng</label>
                            <input type="number" id="hargaGrosirRenteng" min="0" class="input-modern w-full">
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 pt-6">
                    <button type="submit" class="btn-modern btn-success-modern flex-1">
                        <i class="fas fa-save mr-2"></i>Simpan Produk
                    </button>
                    <button type="button" onclick="closeModalProduk()" class="btn-modern btn-danger-modern flex-1">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal untuk Form Pelanggan -->
    <div id="modalPelanggan" class="fixed inset-0 modal-modern hidden flex items-center justify-center p-4 z-50">
        <div class="modal-content p-8 w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 flex items-center" id="modalPelangganTitle">
                <i class="fas fa-user-plus mr-3 text-indigo-600"></i>
                Tambah Pelanggan
            </h3>
            <form id="formPelanggan" class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Toko</label>
                    <input type="text" id="namaToko" required class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pemilik</label>
                    <input type="text" id="namaPemilik" required class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipe Pelanggan</label>
                    <select id="tipePelanggan" required class="input-modern w-full">
                        <option value="">Pilih Tipe</option>
                        <option value="umum">Umum</option>
                        <option value="grosir">Grosir</option>
                    </select>
                </div>
                <div class="flex flex-col md:flex-row gap-4 pt-6">
                    <button type="submit" class="btn-modern btn-success-modern flex-1">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" onclick="closeModalPelanggan()" class="btn-modern btn-danger-modern flex-1">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Checkout -->
    <div id="modalCheckout" class="fixed inset-0 modal-modern hidden flex items-center justify-center p-4 z-50">
        <div class="modal-content p-8 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-credit-card mr-3 text-green-600"></i>
                Checkout Transaksi
            </h3>
            <div class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <div class="flex justify-between items-center mb-2">
                        <span>Total Belanja:</span>
                        <span class="text-2xl font-bold text-green-600">Rp <span id="checkoutTotal">0</span></span>
                    </div>
                    <div class="text-sm text-gray-600">
                        Pelanggan: <span id="checkoutPelanggan">-</span>
                    </div>
                </div>
                
                <select id="metodePembayaran" class="input-modern w-full">
  <option value="tunai">Tunai</option>
  <option value="transfer">Transfer Bank</option>
  <option value="qris">QRIS</option>
  <option value="casbon">Casbon</option> <!-- ‚úÖ Tambahkan ini -->
        </select>
        <div id="formNamaCasbon" class="mt-4 hidden">
  <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Pengasbon</label>
  <input type="text" id="namaPengasbon" class="input-modern w-full" placeholder="Masukkan nama pengasbon">
</div>

                <div id="pembayaranTunai">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Jumlah Bayar</label>
                    <input type="number" id="jumlahBayar" min="0" class="input-modern w-full" placeholder="Masukkan jumlah bayar">
                    <div class="mt-2 text-sm">
                        <span>Kembalian: Rp <span id="kembalian" class="font-bold text-green-600">0</span></span>
                    </div>
                </div>

                <div class="flex gap-4 pt-6">
                    <button onclick="konfirmasiCheckout()" class="btn-modern btn-success-modern flex-1">
                        <i class="fas fa-check mr-2"></i>Konfirmasi
                    </button>
                    <button onclick="closeModalCheckout()" class="btn-modern btn-danger-modern flex-1">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    </div>
     <!-- Modal Scan Barcode -->
<div id="modalScanner" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl p-6 max-w-md w-full">
    <h3 class="text-lg font-semibold mb-4">Scan Barcode</h3>
    <div id="scanner" class="rounded overflow-hidden"></div>
    <div class="text-right mt-4">
      <button onclick="closeScanner()" class="btn-modern btn-danger-modern">
        <i class="fas fa-times mr-2"></i> Tutup
      </button>
    </div>
  </div>
</div>
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Data Storage
        let produkData = [];
        let pelangganData = [
            { id: 'umum', namaToko: 'Pelanggan Umum', namaPemilik: '-', tipe: 'umum' }
        ];
        let transaksiData = [];
        let keranjang = [];
        let editMode = false;
        let editId = null;
        let produkSiap = false;
        // Initialize
      document.addEventListener('DOMContentLoaded', function() {  
    updateTime();
    setInterval(updateTime, 1000);
    ambilProdukDariFirebase();      // ‚úÖ Ambil data produk dari Firebase
    ambilPelangganDariFirebase();   // ‚úÖ Ambil data pelanggan dari Firebase
    ambilTransaksiDariFirebase();   // ‚úÖ (Tambahkan ini!)
    ambilKulakanDariFirebase(); // ‚úÖ tambahkan ini
    ambilCasbonDariFirebase();
    renderProdukTable();
    updateStatistik();

    // Event Listeners
    document.getElementById('searchProdukKasir').addEventListener('input', searchProduk);
    document.getElementById('jumlahBayar').addEventListener('input', hitungKembalian);
    document.getElementById('metodePembayaran').addEventListener('change', togglePembayaranTunai);

    // Form Events
    document.getElementById('formProduk').addEventListener('submit', handleSubmitProduk);
    document.getElementById('formPelanggan').addEventListener('submit', handleSubmitPelanggan);
});


        // Time Update
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

async function filterKulakan() {
  const mulai = document.getElementById("tanggalMulaiKulakan").value;
  const selesai = document.getElementById("tanggalSelesaiKulakan").value;

  if (!mulai || !selesai) {
    alert("Pilih tanggal mulai dan tanggal selesai!");
    return;
  }

  const data = [];
  const snapshot = await get(ref(db, "kulakan"));
  if (snapshot.exists()) {
    snapshot.forEach(child => {
      const item = child.val();
      if (item.tanggal) {
        const [tgl] = item.tanggal.split(',');
        const [d, m, y] = tgl.trim().split('/');
        const isoTanggal = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;

        if (isoTanggal >= mulai && isoTanggal <= selesai) {
          data.push(item);
        }
      }
    });
  }
  tampilkanSummaryKulakan();
  renderKulakanTerfilter(data); // Tampilkan hasil
}

function ambilKulakanDariFirebase() {
  const kulakanRef = ref(db, 'kulakan');
  onValue(kulakanRef, (snapshot) => {
    const data = snapshot.val();
    dataKulakan = data ? Object.values(data) : [];
    renderKulakan();
    tampilkanSummaryKulakan();
  });
}
async function hapusKulakanTerfilter() {
  const mulai = document.getElementById("tanggalMulaiKulakan").value;
  const selesai = document.getElementById("tanggalSelesaiKulakan").value;

  if (!mulai || !selesai) {
    alert("Pilih tanggal mulai dan tanggal selesai!");
    return;
  }

  if (!confirm("Yakin ingin menghapus semua data kulakan dalam rentang tanggal ini?")) return;

  try {
    const snapshot = await get(ref(db, "kulakan"));
    if (!snapshot.exists()) {
      alert("Tidak ada data kulakan.");
      return;
    }

    const semua = snapshot.val();
    const updates = {};

    for (const id in semua) {
      const item = semua[id];
      if (!item.tanggal) continue;

      const [tgl] = item.tanggal.split(',');
      const [d, m, y] = tgl.trim().split('/');
      const isoTanggal = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;

      if (isoTanggal >= mulai && isoTanggal <= selesai) {
        updates[`kulakan/${id}`] = null;
      }
    }

    if (Object.keys(updates).length === 0) {
      alert("Tidak ada data dalam rentang tanggal tersebut.");
      return;
    }

    await update(ref(db), updates);
    showNotification("Data kulakan berhasil dihapus!", "success");
    ambilKulakanDariFirebase(); // Refresh tampilan
  } catch (error) {
    console.error("Gagal hapus kulakan:", error);
    alert("Terjadi kesalahan saat menghapus.");
  }
}

function tampilkanSummaryKulakan() {
  let totalQty = 0;
  let totalHarga = 0;

  dataKulakan.forEach(item => {
    const qty = Number(item.qty) || 0;
    const subtotal = Number(item.total) || 0;

    totalQty += qty;
    totalHarga += subtotal;
  });

  document.getElementById('totalBarangMasuk').textContent = totalQty;
  document.getElementById('totalHargaKulakan').textContent = 'Rp ' + formatRupiah(totalHarga);
}
function exportKulakanExcel() {
  const table = document.getElementById("kulakanTable");
  if (!table || table.rows.length === 0) {
    alert("Tidak ada data kulakan yang bisa diexport.");
    return;
  }

  try {
    // Ambil ringkasan dari UI
    const totalBarangMasuk = document.getElementById("totalBarangMasuk")?.textContent || "0";
    const totalHargaKulakan = document.getElementById("totalHargaKulakan")?.textContent || "Rp 0";

    // Buat ringkasan (2 baris)
    const summary = [
      ["Total Barang Masuk", totalBarangMasuk],
      ["Total Harga Kulakan", totalHargaKulakan],
      [],
    ];

    // Ambil isi data dari tabel (kita ambil langsung tr ‚Üí td)
    const headers = ["Tanggal", "Nama", "Supplier", "Qty", "Harga", "Total"];
    const data = Array.from(table.querySelectorAll("tr")).map(row => {
      return Array.from(row.querySelectorAll("td")).map(cell => cell.innerText.trim());
    }).filter(row => row.length > 0); // hapus row kosong

    // Gabungkan semua ke satu array
    const finalData = [...summary, headers, ...data];

    // Buat dan simpan file
    const ws = XLSX.utils.aoa_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Kulakan");
    XLSX.writeFile(wb, "laporan-kulakan.xlsx");
  } catch (error) {
    console.error("Export gagal:", error);
    alert("Terjadi kesalahan saat export kulakan.");
  }
}

function formatRupiah(angka) {
  return angka.toLocaleString('id-ID');
}

async function ambilCasbonDariFirebase() {
  const snapshot = await get(ref(db, 'casbon'));
  dataCasbon = [];

  if (snapshot.exists()) {
    snapshot.forEach(child => {
      const data = child.val();
      dataCasbon.push({
        key: child.key,
        tanggal: data.tanggal || '-',
        pelanggan: data.namaPengasbon || data.pelanggan || data.pelangganId || '-',
        total: data.total || 0,
        sisa: data.sisa ?? (data.total - (data.jumlahBayar || 0)),
        status: data.status || 'belum lunas'
      });
    });
  }

  renderCasbon();
}


        function showSection(sectionName) {
  // Sembunyikan semua section
  document.querySelectorAll('.section').forEach(section => {
    section.classList.add('hidden');
  });

  // Hapus "active" dari semua tombol nav
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.remove('active');
  });

  // Tampilkan section utama
  const mainSection = document.getElementById('section-' + sectionName);
  if (mainSection) {
    mainSection.classList.remove('hidden');
  } else if (sectionName === 'casbon') {
    // Tambahan khusus untuk casbon
    document.getElementById('section-laporan').classList.remove('hidden');
    document.getElementById('section-casbon').classList.remove('hidden');
  }

  // Tandai tombol aktif
  event.target.classList.add('active');
}

function filterProduk() {
  const keyword = document.getElementById('searchProdukManajemen').value.toLowerCase();
  const hasilFilter = produkData.filter(produk =>
    produk.nama.toLowerCase().includes(keyword) ||
    (produk.barcode && produk.barcode.toLowerCase().includes(keyword))
  );

  tampilkanHasilFilterProduk(hasilFilter);
}
async function hapusLaporanTerfilter() {
  if (!confirm("Yakin ingin menghapus semua data laporan yang tampil saat ini?")) return;

  const tanggalMulai = document.getElementById('tanggalMulai').value;
  const tanggalAkhir = document.getElementById('tanggalSelesai').value;


  if (!tanggalMulai || !tanggalAkhir) {
    alert("Tanggal filter belum lengkap.");
    return;
  }

  const startDate = new Date(tanggalMulai);
  const endDate = new Date(tanggalAkhir);
  endDate.setHours(23, 59, 59, 999);

  try {
    const transaksiRef = ref(db, 'transaksi');
    const snapshot = await get(transaksiRef);

    if (snapshot.exists()) {
      const semuaTransaksi = snapshot.val();
      const updates = {};

      for (const id in semuaTransaksi) {
        const transaksi = semuaTransaksi[id];
        if (!transaksi.tanggal) continue;

        // Format tanggal kamu: "4/7/2025"
        const waktu = new Date(transaksi.tanggal); // karena sudah dalam format YYYY-MM-DD
        if (waktu >= startDate && waktu <= endDate) {
          updates[`transaksi/${id}`] = null;
        }
      }

      if (Object.keys(updates).length === 0) {
        alert("Tidak ada data dalam rentang tanggal tersebut.");
        return;
      }

      await update(ref(db), updates);
      showNotification("Data laporan terfilter berhasil dihapus!", "success");
      filterLaporan(); // Perbarui tampilan
    }
  } catch (err) {
    console.error("Gagal menghapus data:", err);
    alert("Terjadi kesalahan saat menghapus data.");
  }
}

function tampilkanHasilFilterProduk(filteredList) {
  const tbody = document.getElementById('produkTable');
  tbody.innerHTML = '';

  if (filteredList.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-gray-400 py-6">
          Tidak ada produk ditemukan.
        </td>
      </tr>
    `;
    return;
  }

  filteredList.forEach(produk => {
    const row = `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="font-semibold text-gray-800">${produk.nama}</td>
        <td class="text-gray-600">${produk.barcode || '-'}</td>
        <td class="text-gray-600">${produk.kategori}</td>
        <td class="text-center">
          <span class="px-3 py-1 rounded-full text-sm font-medium ${produk.stok > 10 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            ${produk.stok} pcs
          </span>
        </td>
        <td class="text-right font-medium">Rp ${formatRupiah(produk.harga.umum.pcs)}</td>
        <td class="text-right font-medium">Rp ${formatRupiah(produk.harga.grosir.pcs)}</td>
        <td class="text-center">
          <div class="flex justify-center gap-2">
            <button onclick="editProduk('${produk.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="hapusProduk('${produk.id}')" class="text-red-600 hover:text-red-800 transition-colors">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}


        // Produk Management
        function renderProdukTable() {
    const tbody = document.getElementById('produkTable');
    tbody.innerHTML = '';

    produkData.forEach(produk => {
        const row = `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="font-semibold text-gray-800">${produk.nama}</td>
                <td class="text-gray-600">${produk.barcode || '-'}</td> <!-- Tambahan -->
                <td class="text-gray-600">${produk.kategori}</td>
                <td class="text-center">
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${produk.stok > 10 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${produk.stok} pcs
                    </span>
                </td>
                <td class="text-right font-medium">Rp ${formatRupiah(produk.harga.umum.pcs)}</td>
                <td class="text-right font-medium">Rp ${formatRupiah(produk.harga.grosir.pcs)}</td>
                <td class="text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="editProduk('${produk.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="hapusProduk('${produk.id}')" class="text-red-600 hover:text-red-800 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

        function showTambahProduk() {
            editMode = false;
            editId = null;
            document.getElementById('modalProdukTitle').innerHTML = '<i class="fas fa-plus mr-3 text-indigo-600"></i>Tambah Produk';
            document.getElementById('formProduk').reset();
            document.getElementById('modalProduk').classList.remove('hidden');
        }

        function editProduk(id) {
            const produk = produkData.find(p => p.id === id);
            if (!produk) return;

            editMode = true;
            editId = id;
            document.getElementById('modalProdukTitle').innerHTML = '<i class="fas fa-edit mr-3 text-indigo-600"></i>Edit Produk';
            
            // Fill form
            document.getElementById('namaProduk').value = produk.nama;
            document.getElementById('kategoriProduk').value = produk.kategori;
            document.getElementById('stokProduk').value = produk.stok;
            document.getElementById('konversiDus').value = produk.konversiDus;
            document.getElementById('konversiRenteng').value = produk.konversiRenteng;
            
            // Harga Umum
            document.getElementById('hargaUmumPcs').value = produk.harga.umum.pcs;
            document.getElementById('hargaUmumDus').value = produk.harga.umum.dus;
            document.getElementById('hargaUmumRenteng').value = produk.harga.umum.renteng;
            
            // Harga Grosir
            document.getElementById('hargaGrosirPcs').value = produk.harga.grosir.pcs;
            document.getElementById('hargaGrosirDus').value = produk.harga.grosir.dus;
            document.getElementById('hargaGrosirRenteng').value = produk.harga.grosir.renteng;
            
            document.getElementById('modalProduk').classList.remove('hidden');
        }

        async function handleSubmitProduk(e) {
  e.preventDefault();

  const produkBaru = {
    barcode: document.getElementById('barcodeProduk').value,
    nama: document.getElementById('namaProduk').value,
    kategori: document.getElementById('kategoriProduk').value,
    stok: parseInt(document.getElementById('stokProduk').value),
    konversiDus: parseInt(document.getElementById('konversiDus').value),
    konversiRenteng: parseInt(document.getElementById('konversiRenteng').value),
    harga: {
      umum: {
        pcs: parseInt(document.getElementById('hargaUmumPcs').value),
        dus: parseInt(document.getElementById('hargaUmumDus').value),
        renteng: parseInt(document.getElementById('hargaUmumRenteng').value)
      },
      grosir: {
        pcs: parseInt(document.getElementById('hargaGrosirPcs').value),
        dus: parseInt(document.getElementById('hargaGrosirDus').value),
        renteng: parseInt(document.getElementById('hargaGrosirRenteng').value)
      }
    }
  };

  let produkRef;
  if (editMode && editId) {
    produkBaru.id = editId;
    produkRef = ref(db, 'produk/' + editId); // ‚¨Ö update
  } else {
    produkRef = push(ref(db, 'produk')); // ‚¨Ö buat baru
    produkBaru.id = produkRef.key;
  }

  await set(produkRef, produkBaru);

  showNotification('Produk berhasil disimpan di Firebase!', 'success');
  closeModalProduk();
  ambilProdukDariFirebase(); // refresh tampilan produk
}


function ambilProdukDariFirebase() {
  const produkRef = ref(db, 'produk');
  onValue(produkRef, (snapshot) => {
    const data = snapshot.val();
    produkData = [];

    if (data) {
      for (let key in data) {
        produkData.push({ id: key, ...data[key] }); // üëà tambahkan ID dari key Firebase
      }
    }

    renderProdukTable();
    produkSiap = true; // ‚úÖ Tambahkan baris ini di akhir!
  });
}


    async function hapusProduk(id) {
  if (!confirm('Yakin ingin menghapus produk ini?')) return;

  try {
    await remove(ref(db, `produk/${id}`));
    showNotification('Produk berhasil dihapus dari Firebase!', 'success');
    ambilProdukDariFirebase(); // Refresh data di tabel
  } catch (error) {
    showNotification('Gagal menghapus produk.', 'error');
    console.error(error);
  }
}
function exportToExcel() {
  const table = document.getElementById("laporanTable");
  if (!table || table.rows.length <= 1) {
    alert("Tidak ada data yang bisa diexport!");
    return;
  }

  try {
    // 1. Ambil nilai ringkasan
    const totalTransaksi = document.getElementById("laporanTotalTransaksi").textContent || "0";
    const totalPendapatan = document.getElementById("laporanTotalPendapatan").textContent || "0";
    const produkTerjual = document.getElementById("laporanProdukTerjual").textContent || "0";

    // 2. Buat array data ringkasan
    const summary = [
      ["Total Transaksi", totalTransaksi],
      ["Total Pendapatan", "Rp " + totalPendapatan],
      ["Produk Terjual", produkTerjual],
      [],
    ];

    // 3. Buat array data tabel tanpa kolom aksi
    const headers = ["Tanggal", "Pelanggan", "Item", "Total"];
    const data = Array.from(table.querySelectorAll("tbody tr")).map(row => {
      const cells = row.querySelectorAll("td");
      return [
        cells[0]?.innerText.trim(), // Tanggal
        cells[1]?.innerText.trim(), // Pelanggan
        cells[2]?.innerText.trim(), // Item
        cells[3]?.innerText.trim(), // Total
      ];
    });

    const finalData = [...summary, headers, ...data];

    // 4. Export
    const ws = XLSX.utils.aoa_to_sheet(finalData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Laporan Penjualan");
    XLSX.writeFile(wb, "laporan-penjualan.xlsx");
  } catch (error) {
    console.error("Gagal export:", error);
    alert("Terjadi kesalahan saat export Excel.");
  }
}

     function closeModalProduk() {
            document.getElementById('modalProduk').classList.add('hidden');
        }

        // Pelanggan Management
        function renderPelangganTable() {
            const tbody = document.getElementById('pelangganTable');
            tbody.innerHTML = '';

            pelangganData.filter(p => p.id !== 'umum').forEach(pelanggan => {
                const row = `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="font-semibold text-gray-800">${pelanggan.namaToko}</td>
                        <td class="text-gray-600">${pelanggan.namaPemilik}</td>
                        <td class="text-center">
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${pelanggan.tipe === 'grosir' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                ${pelanggan.tipe === 'grosir' ? 'Grosir' : 'Umum'}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="editPelanggan('${pelanggan.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="hapusPelanggan('${pelanggan.id}')" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updatePelangganSelect() {
            const select = document.getElementById('selectPelanggan');
            select.innerHTML = '';
            
            pelangganData.forEach(pelanggan => {
                const option = document.createElement('option');
                option.value = pelanggan.id;
                option.textContent = pelanggan.namaToko;
                select.appendChild(option);
            });
        }

        function showTambahPelanggan() {
            editMode = false;
            editId = null;
            document.getElementById('modalPelangganTitle').innerHTML = '<i class="fas fa-user-plus mr-3 text-indigo-600"></i>Tambah Pelanggan';
            document.getElementById('formPelanggan').reset();
            document.getElementById('modalPelanggan').classList.remove('hidden');
        }

        function editPelanggan(id) {
            const pelanggan = pelangganData.find(p => p.id === id);
            if (!pelanggan) return;

            editMode = true;
            editId = id;
            document.getElementById('modalPelangganTitle').innerHTML = '<i class="fas fa-user-edit mr-3 text-indigo-600"></i>Edit Pelanggan';
            
            document.getElementById('namaToko').value = pelanggan.namaToko;
            document.getElementById('namaPemilik').value = pelanggan.namaPemilik;
            document.getElementById('tipePelanggan').value = pelanggan.tipe;
            
            document.getElementById('modalPelanggan').classList.remove('hidden');
        }

        function ambilPelangganDariFirebase() {
  const pelangganRef = ref(db, 'pelanggan');
  onValue(pelangganRef, (snapshot) => {
    const data = snapshot.val();
    pelangganData = [{ id: 'umum', namaToko: 'Pelanggan Umum', namaPemilik: '-', tipe: 'umum' }];
    if (data) {
      pelangganData.push(...Object.values(data));
    }
    renderPelangganTable();
    updatePelangganSelect();
  });
}

        async function handleSubmitPelanggan(e) {
  e.preventDefault();

  const pelangganBaru = {
    namaToko: document.getElementById('namaToko').value,
    namaPemilik: document.getElementById('namaPemilik').value,
    tipe: document.getElementById('tipePelanggan').value
  };

  if (editMode && editId) {
    await set(ref(db, `pelanggan/${editId}`), { id: editId, ...pelangganBaru });
    showNotification('Pelanggan berhasil diperbarui!', 'success');
  } else {
    const pelangganRef = push(ref(db, 'pelanggan'));
    const id = pelangganRef.key;
    await set(pelangganRef, { id, ...pelangganBaru });
    showNotification('Pelanggan berhasil ditambahkan!', 'success');
  }

  closeModalPelanggan();
  ambilPelangganDariFirebase(); // Refresh UI
}


        async function hapusPelanggan(id) {
  if (!confirm('Yakin ingin menghapus pelanggan ini?')) return;

  try {
    await remove(ref(db, `pelanggan/${id}`)); // ‚¨ÖÔ∏è Hapus dari Firebase
    showNotification('Pelanggan berhasil dihapus!', 'success');
    ambilPelangganDariFirebase(); // ‚¨ÖÔ∏è Refresh data
  } catch (error) {
    console.error(error);
    showNotification('Gagal menghapus pelanggan.', 'error');
  }
}

        function closeModalPelanggan() {
            document.getElementById('modalPelanggan').classList.add('hidden');
        }

        // Search Produk
        function searchProduk() {
  const query = event.target.value.toLowerCase();
  const suggestions = document.getElementById('searchSuggestions');

  if (query.length < 2) {
    suggestions.classList.add('hidden');
    return;
  }

  const filtered = produkData.filter(produk =>
    produk.nama.toLowerCase().includes(query) ||
    produk.kategori.toLowerCase().includes(query) ||
    (produk.barcode && produk.barcode.toLowerCase().includes(query)) // ‚úÖ Tambahan ini
  );

  if (filtered.length === 0) {
    suggestions.classList.add('hidden');
    return;
  }

  suggestions.innerHTML = '';
  filtered.forEach(produk => {
    const div = document.createElement('div');
    div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b last:border-b-0';
    div.innerHTML = `
      <div class="font-semibold">${produk.nama}</div>
      <div class="text-sm text-gray-600">${produk.kategori} - Stok: ${produk.stok}</div>
    `;
    div.onclick = () => tambahKeKeranjang(produk.id);
    suggestions.appendChild(div);
  });

  suggestions.classList.remove('hidden');
}

function hitungTotal() {
  return keranjang.reduce((sum, item) => sum + item.subtotal, 0);
}

        // Keranjang Management
       function tambahKeKeranjang(produkId) {
  // Cari data produk berdasarkan ID
  const produk = produkData.find(p => p.id === produkId);
  if (!produk) {
    showNotification('Produk tidak ditemukan.', 'error');
    return;
  }

  // Ambil tipe pelanggan
  const pelangganId = document.getElementById('selectPelanggan').value;
  const pelanggan = pelangganData.find(p => p.id === pelangganId);
  const tipe = pelanggan ? pelanggan.tipe : 'umum';

  // Hitung harga sesuai tipe pelanggan dan satuan default
  const satuan = 'pcs'; // default satuan
  const harga = produk.harga?.[tipe]?.[satuan] || 0;

  // Cek apakah produk sudah ada di keranjang
  const existingItem = keranjang.find(item => item.produkId === produkId && item.satuan === satuan);

  if (existingItem) {
    existingItem.qty += 1;
  } else {
    keranjang.push({
      produkId: produkId,
      nama: produk.nama,
      qty: 1,
      satuan: satuan,
      harga: harga
    });
  }

  renderKeranjang();
  document.getElementById('searchProdukKasir').value = '';
  document.getElementById('searchSuggestions').classList.add('hidden');
  showNotification('Produk ditambahkan ke keranjang', 'success');
}
        function renderKeranjang() {
            const tbody = document.getElementById('keranjangTable');
            
            if (keranjang.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-12 text-gray-500">
                            <i class="fas fa-shopping-cart text-4xl mb-4 opacity-50"></i>
                            <p>Keranjang masih kosong</p>
                        </td>
                    </tr>
                `;
                document.getElementById('totalBelanja').textContent = '0';
                return;
            }

            tbody.innerHTML = '';
            let total = 0;

            const pelangganTerpilih = document.getElementById('selectPelanggan').value;
            const pelanggan = pelangganData.find(p => p.id === pelangganTerpilih);
            const tipePelanggan = pelanggan ? pelanggan.tipe : 'umum';

            keranjang.forEach((item, index) => {
                const produk = produkData.find(p => p.id === item.produkId);
                let hargaSatuan = produk.harga[tipePelanggan][item.satuan];
                let subtotal = hargaSatuan * item.qty;
                total += subtotal;

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="font-semibold">${item.nama}</td>
                        <td class="text-center">
                            <select onchange="updateSatuan(${index}, this.value)" class="input-modern text-sm">
                                <option value="pcs" ${item.satuan === 'pcs' ? 'selected' : ''}>PCS</option>
                                <option value="dus" ${item.satuan === 'dus' ? 'selected' : ''}>DUS</option>
                                <option value="renteng" ${item.satuan === 'renteng' ? 'selected' : ''}>RENTENG</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="updateQty(${index}, ${item.qty - 1})" class="w-8 h-8 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                                    <i class="fas fa-minus text-xs"></i>
                                </button>
                                <span class="font-semibold min-w-[30px] text-center">${item.qty}</span>
                                <button onclick="updateQty(${index}, ${item.qty + 1})" class="w-8 h-8 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition-colors">
                                    <i class="fas fa-plus text-xs"></i>
                                </button>
                            </div>
                        </td>
                        <td class="text-right font-medium">Rp ${formatRupiah(hargaSatuan)}</td>
                        <td class="text-right font-bold">Rp ${formatRupiah(subtotal)}</td>
                        <td class="text-center">
                            <button onclick="hapusDariKeranjang(${index})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    <td class="text-right font-medium">Rp ${formatRupiah(hargaSatuan)}</td>
                        <td class="text-right font-bold">Rp ${formatRupiah(subtotal)}</td>
                        <td class="text-center">
                            <button onclick="hapusDariKeranjang(${index})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('totalBelanja').textContent = formatRupiah(total);
        }

        function updateSatuan(index, satuanBaru) {
            const item = keranjang[index];
            const produk = produkData.find(p => p.id === item.produkId);
            const pelangganTerpilih = document.getElementById('selectPelanggan').value;
            const pelanggan = pelangganData.find(p => p.id === pelangganTerpilih);
            const tipePelanggan = pelanggan ? pelanggan.tipe : 'umum';
            
            item.satuan = satuanBaru;
            item.harga = produk.harga[tipePelanggan][satuanBaru];
            renderKeranjang();
        }

        function updateQty(index, qtyBaru) {
            if (qtyBaru <= 0) {
                hapusDariKeranjang(index);
                return;
            }
            
            keranjang[index].qty = qtyBaru;
            renderKeranjang();
        }

        function hapusDariKeranjang(index) {
            keranjang.splice(index, 1);
            renderKeranjang();
        }

        function clearKeranjang() {
            if (keranjang.length === 0) return;
            
            if (confirm('Yakin ingin mengosongkan keranjang?')) {
                keranjang = [];
                renderKeranjang();
                showNotification('Keranjang berhasil dikosongkan!', 'success');
            }
        }

        // Checkout
        function prosesCheckout() {
            if (keranjang.length === 0) {
                showNotification('Keranjang masih kosong!', 'error');
                return;
            }

            const total = keranjang.reduce((sum, item) => {
                const produk = produkData.find(p => p.id === item.produkId);
                const pelangganTerpilih = document.getElementById('selectPelanggan').value;
                const pelanggan = pelangganData.find(p => p.id === pelangganTerpilih);
                const tipePelanggan = pelanggan ? pelanggan.tipe : 'umum';
                return sum + (produk.harga[tipePelanggan][item.satuan] * item.qty);
            }, 0);

            const pelangganTerpilih = document.getElementById('selectPelanggan').value;
            const pelanggan = pelangganData.find(p => p.id === pelangganTerpilih);

            document.getElementById('checkoutTotal').textContent = formatRupiah(total);
            document.getElementById('checkoutPelanggan').textContent = pelanggan.namaToko;
            document.getElementById('jumlahBayar').value = '';
            document.getElementById('kembalian').textContent = '0';
            document.getElementById('metodePembayaran').value = 'tunai';
            togglePembayaranTunai();
            
            document.getElementById('modalCheckout').classList.remove('hidden');
        }

        function togglePembayaranTunai() {
  const metode = document.getElementById('metodePembayaran').value;
  const pembayaranTunai = document.getElementById('pembayaranTunai');
  const formNamaCasbon = document.getElementById('formNamaCasbon');

  if (metode === 'tunai') {
    pembayaranTunai.style.display = 'block';
    formNamaCasbon.classList.add('hidden');
  } else if (metode === 'casbon') {
    pembayaranTunai.style.display = 'none';
    formNamaCasbon.classList.remove('hidden');
  } else {
    pembayaranTunai.style.display = 'none';
    formNamaCasbon.classList.add('hidden');
  }
}


        function hitungKembalian() {
            const total = keranjang.reduce((sum, item) => {
                const produk = produkData.find(p => p.id === item.produkId);
                const pelangganTerpilih = document.getElementById('selectPelanggan').value;
                const pelanggan = pelangganData.find(p => p.id === pelangganTerpilih);
                const tipePelanggan = pelanggan ? pelanggan.tipe : 'umum';
                return sum + (produk.harga[tipePelanggan][item.satuan] * item.qty);
            }, 0);

            const bayar = parseFloat(this.value) || 0;
            const kembalian = bayar - total;
            
            document.getElementById('kembalian').textContent = formatRupiah(Math.max(0, kembalian));
        }

let qrScannerInstance;

function scanKulakanBarcode() {
  openScanner((hasilScan) => {
    document.getElementById('kulakanBarcode').value = hasilScan;
    playBeep(); // ‚úÖ Tambahkan ini
  });
}

let isScannerDetected = false;
let scannerTimeout;

document.getElementById('searchProdukKasir').addEventListener('input', (e) => {
  clearTimeout(scannerTimeout);

  // Anggap inputan sangat cepat itu dari scanner
  if (!isScannerDetected) {
    isScannerDetected = true;
    console.log("üñ®Ô∏è Deteksi: USB scanner aktif");
  }

  // Reset flag jika tidak ada input lagi selama 1 detik
  scannerTimeout = setTimeout(() => {
    isScannerDetected = false;
    console.log("üì∑ Deteksi: USB scanner nonaktif, kamera bisa digunakan");
  }, 1000);
});


function openScanner(callback = null) {
  console.log("üîç Fungsi openScanner() dipanggil");

  if (isScannerDetected) {
    showNotification("üñ®Ô∏è USB Scanner aktif, gunakan scanner untuk input barcode.", "success");
    return; // Jangan lanjut buka kamera
  }

  if (!produkSiap) {
    showNotification("‚è≥ Tunggu data produk siap...", "error");
    return;
  }

  scannerCallback = callback;
  barcodeDetected = false;
  const scannerElement = document.getElementById("scanner");
  scannerElement.innerHTML = '';
  document.getElementById("modalScanner").classList.remove("hidden");

  Quagga.offDetected();

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: scannerElement,
      constraints: {
        facingMode: "environment",
        width: { ideal: 640 },
        height: { ideal: 480 }
      }
    },
    locator: {
      patchSize: "medium",
      halfSample: false
    },
    decoder: {
      readers: ["ean_reader", "code_128_reader", "upc_reader"]
    },
    locate: true,
    frequency: 5,
    numOfWorkers: 2
  }, function (err) {
    if (err) {
      console.error("‚ùå Gagal inisialisasi Quagga:", err.name || err);
      showNotification("Gagal membuka kamera: " + err.name, "error");

      if (err.name === "NotAllowedError") {
        alert("‚ùå Akses kamera ditolak. Silakan izinkan akses kamera di browser.");
      } else if (err.name === "NotFoundError") {
        alert("‚ùå Kamera tidak ditemukan. Pastikan perangkat memiliki kamera.");
      }

      return;
    }

    console.log("‚úÖ Quagga scanner berhasil dimulai!");
    Quagga.start();
  });

  Quagga.onDetected(function (result) {
    const code = result.codeResult.code;
    console.log("‚úÖ Barcode terdeteksi:", code);

    if (typeof scannerCallback === 'function') {
      scannerCallback(code);
    } else {
      handleBarcodeResult(code);
    }

    Quagga.stop();
    document.getElementById("modalScanner").classList.add("hidden");
  });
}


function closeScanner() {
  try {
    Quagga.stop();
    Quagga.offDetected(); // tambahkan ini juga di sini
  } catch (e) {
    console.warn("Tidak bisa stop scanner:", e);
  }
  document.getElementById("modalScanner").classList.add("hidden");
}



function handleBarcodeResult(barcode) {
  console.log("Barcode hasil scan:", barcode.trim());
  console.log("Semua barcode produk:", produkData.map(p => p.barcode));

  const produk = produkData.find(p => p.barcode?.trim() === barcode.trim());

  if (produk) {
    tambahKeKeranjang(produk.id);
    showNotification(`Produk "${produk.nama}" ditambahkan ke keranjang.`, 'success');
    playBeep();
  } else {
    showNotification('Produk tidak ditemukan.', 'error');
  }
}



  async function konfirmasiCheckout() {
  if (keranjang.length === 0) {
    alert('Keranjang kosong!');
    return;
  }

  const pelangganId = document.getElementById('selectPelanggan').value;
  const metodePembayaran = document.getElementById('metodePembayaran').value;
  let jumlahBayar = parseInt(document.getElementById('jumlahBayar').value);
  const namaPengasbon = document.getElementById('namaPengasbon')?.value || "";
  const total = hitungTotal();

  if (metodePembayaran === "casbon") {
    jumlahBayar = 0;
    if (!namaPengasbon.trim()) {
      showNotification('Nama pengasbon wajib diisi!', 'error');
      return;
    }
  }

  const kembalian = jumlahBayar - total;
  const tanggal = new Date().toISOString(); // ‚úÖ lengkap dengan jam dan detik

  if (metodePembayaran !== "casbon") {
    if (isNaN(jumlahBayar) || jumlahBayar < 0) {
      showNotification('Jumlah bayar harus diisi dengan benar!', 'error');
      return;
    }
  }

  const transaksiBaru = {
    pelangganId,
    metodePembayaran,
    jumlahBayar,
    total,
    kembalian,
    tanggal,
    namaPengasbon: metodePembayaran === "casbon" ? namaPengasbon : "",
    status: metodePembayaran === "casbon" ? "Belum Lunas" : "Lunas",
    sisa: metodePembayaran === "casbon" ? total : 0,
    items: keranjang.map(item => ({
      id: item.produkId,
      nama: item.nama,
      qty: item.qty,
      satuan: item.satuan,
      hargaSatuan: item.harga,
      subtotal: item.qty * item.harga
    }))
  };

  try {
    // ‚¨áÔ∏è SIMPAN KE LOKASI YANG SESUAI
    const transaksiRef = metodePembayaran === 'casbon'
      ? push(ref(db, 'casbon'))
      : push(ref(db, 'transaksi'));

    await set(transaksiRef, transaksiBaru);
    await kurangiStokProduk(transaksiBaru);

    const pelanggan = pelangganData.find(p => p.id === transaksiBaru.pelangganId);
    tampilkanStruk(transaksiBaru, pelanggan, jumlahBayar, kembalian);

    keranjang = [];
    renderKeranjang();
    closeModalCheckout();
    ambilTransaksiDariFirebase();
    ambilCasbonDariFirebase(); // refresh tampilan casbon
    showNotification('Transaksi berhasil disimpan', 'success');
  } catch (error) {
    console.error(error);
    showNotification('Gagal menyimpan transaksi.', 'error');
  }
}


function hitungTotal() {
  return keranjang.reduce((sum, item) => sum + (item.qty * item.harga), 0);
}
async function kurangiStokProduk(transaksi) {
  for (let item of transaksi.items) {
    const produk = produkData.find(p => p.id === item.id);
    if (!produk) continue;

    let pengurang = item.qty;

    if (item.satuan === 'dus') {
      pengurang *= produk.konversiDus;
    } else if (item.satuan === 'renteng') {
      pengurang *= produk.konversiRenteng;
    }

    const stokBaru = Math.max(0, produk.stok - pengurang);
    await set(ref(db, `produk/${item.id}/stok`), stokBaru);
  }

  ambilProdukDariFirebase(); // refresh UI produk
}
function editCasbon(id) {
  const casbon = dataCasbon.find(c => c.key === id);
  if (!casbon) return;

  document.getElementById('editCasbonId').value = casbon.key;
  document.getElementById('editNama').value = casbon.pelanggan || '';
  document.getElementById('editTotal').value = casbon.total || '';
  document.getElementById('editStatus').value = casbon.status === 'lunas' ? 'Lunas' : 'Belum Lunas';

  document.getElementById('modalEditCasbon').classList.remove('hidden');
}

function closeModalEditCasbon() {
  document.getElementById('modalEditCasbon').classList.add('hidden');
}

document.getElementById("formEditCasbon").addEventListener("submit", async function(e) {
  e.preventDefault();

  const id = document.getElementById("editCasbonId").value;
  const status = document.getElementById("editStatus").value;
  const sisa = parseInt(document.getElementById("editCasbonSisa").value) || 0;

  const casbonRef = ref(db, "casbon/" + id);
  const snapshot = await get(casbonRef);

  if (!snapshot.exists()) {
    showNotification("Casbon tidak ditemukan!", "error");
    return;
  }

  const transaksi = snapshot.val();
  transaksi.status = status;
  transaksi.sisa = sisa;

  if (status === "Lunas") {
    transaksi.jumlahBayar = transaksi.total;
    transaksi.tanggalLunas = new Date().toISOString().split("T")[0];

    // Simpan ke laporan dulu
    const transaksiRef = push(ref(db, "transaksi"));
    await set(transaksiRef, transaksi);


    // Baru hapus dari casbon
    await remove(casbonRef);
  } else {
    // Jika belum lunas, update datanya
    await set(casbonRef, transaksi);
  }

  closeModalEditCasbon();
  showNotification("Status & sisa casbon berhasil diperbarui!", "success");

  ambilCasbonDariFirebase?.();
  ambilTransaksiDariFirebase?.();
});

function ambilTransaksiDariFirebase() {
  const transaksiRef = ref(db, 'transaksi');
  onValue(transaksiRef, (snapshot) => {
    const data = snapshot.val();
    transaksiData = [];

    if (data) {
      Object.entries(data).forEach(([key, trans]) => {
        const jumlahBayar = parseInt(trans.jumlahBayar) || 0;
        const total = parseInt(trans.total) || 0;

        // ‚úÖ Tampilkan hanya yang sudah lunas
        if (jumlahBayar >= total) {
          transaksiData.push({ id: key, ...trans });
        }
      });
    }

    generateLaporan();
    updateStatistik();
  });
}

async function updateAtauBuatProdukDariKulakan(nama, qty) {
  const produkRef = ref(db, 'produk');
  const snapshot = await get(produkRef);
  const data = snapshot.val();
  let produkAda = false;

  if (data) {
    for (let key in data) {
      if (data[key].nama.toLowerCase() === nama.toLowerCase()) {
        // Produk sudah ada ‚Üí update stok
        const stokBaru = (data[key].stok || 0) + qty;
        await set(ref(db, `produk/${key}/stok`), stokBaru);
        produkAda = true;
        break;
      }
    }
  }

  if (!produkAda) {
    // Produk belum ada ‚Üí buat baru
    const produkBaruRef = push(ref(db, 'produk'));
    const produkBaru = {
      id: produkBaruRef.key,
      nama: nama,
      kategori: "Lainnya",
      stok: qty,
      konversiDus: 12,
      konversiRenteng: 10,
      harga: {
        umum: { pcs: 0, dus: 0, renteng: 0 },
        grosir: { pcs: 0, dus: 0, renteng: 0 }
      }
    };
    await set(produkBaruRef, produkBaru);
  }
}

        function closeModalCheckout() {
            document.getElementById('modalCheckout').classList.add('hidden');
        }

        // Statistik
        function updateStatistik() {
            const today = new Date().toDateString();
            const transaksiHariIni = transaksiData.filter(t => 
                new Date(t.tanggal).toDateString() === today
            );

            const totalTransaksi = transaksiHariIni.length;
            const totalPendapatan = transaksiHariIni.reduce((sum, t) => sum + t.total, 0);

            document.getElementById('totalTransaksiHari').textContent = totalTransaksi;
            document.getElementById('totalPendapatanHari').textContent = formatRupiah(totalPendapatan);
        }

        // Laporan
        function generateLaporan() {
            const periode = document.getElementById('periodeLaporan').value;
            const tanggalMulai = document.getElementById('tanggalMulai').value;
            const tanggalSelesai = document.getElementById('tanggalSelesai').value;

            let transaksiTerfilter = [...transaksiData];

            if (periode === 'hari') {
                const today = new Date().toDateString();
                transaksiTerfilter = transaksiData.filter(t => 
                    new Date(t.tanggal).toDateString() === today
                );
            } else if (periode === 'minggu') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                transaksiTerfilter = transaksiData.filter(t => 
                    new Date(t.tanggal) >= oneWeekAgo
                );
            } else if (periode === 'bulan') {
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                transaksiTerfilter = transaksiData.filter(t => {
                    const transaksiDate = new Date(t.tanggal);
                    return transaksiDate.getMonth() === thisMonth && 
                           transaksiDate.getFullYear() === thisYear;
                });
            }

            if (tanggalMulai && tanggalSelesai) {
                const mulai = new Date(tanggalMulai);
                const selesai = new Date(tanggalSelesai);
                selesai.setHours(23, 59, 59);
                
                transaksiTerfilter = transaksiData.filter(t => {
                    const tanggalTransaksi = new Date(t.tanggal);
                    return tanggalTransaksi >= mulai && tanggalTransaksi <= selesai;
                });
            }

            // Update statistik laporan
            const totalTransaksi = transaksiTerfilter.length;
            const totalPendapatan = transaksiTerfilter.reduce((sum, t) => sum + t.total, 0);
            const totalProdukTerjual = transaksiTerfilter.reduce((sum, t) => 
                sum + t.items.reduce((itemSum, item) => itemSum + item.qty, 0), 0
            );

            document.getElementById('laporanTotalTransaksi').textContent = totalTransaksi;
            document.getElementById('laporanTotalPendapatan').textContent = formatRupiah(totalPendapatan);
            document.getElementById('laporanProdukTerjual').textContent = totalProdukTerjual;

            // Render tabel laporan
            renderLaporanTable(transaksiTerfilter);
        }

        function renderLaporanTable(transaksi) {
  const tbody = document.getElementById('laporanTableBody');
  tbody.innerHTML = '';

  if (transaksi.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-12 text-gray-500">
          <i class="fas fa-chart-bar text-4xl mb-4 opacity-50"></i>
          <p>Tidak ada data transaksi</p>
        </td>
      </tr>
    `;
    return;
  }

  transaksi.forEach(t => {
    const pelanggan = pelangganData.find(p => p.id === t.pelangganId);
    const tanggal = new Date(t.tanggal).toLocaleDateString('id-ID');
    const totalItem = t.items.reduce((sum, item) => sum + item.qty, 0);

    const row = `
      <tr class="hover:bg-gray-50">
        <td class="font-medium">${tanggal}</td>
        <td>${pelanggan ? pelanggan.namaToko : '-'}</td>
        <td class="text-center">${totalItem}</td>
        <td class="text-right font-bold">Rp ${formatRupiah(t.total)}</td>
        <td class="text-center">
          <button onclick="lihatDetailTransaksi('${t.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
            <i class="fas fa-eye"></i> Detail
          </button>
        </td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}

function lihatDetailTransaksi(id) {
  const trans = transaksiData.find(t => t.id === id);
  if (!trans || !trans.items) return;

  const isi = document.getElementById("detailIsiProduk");
  isi.innerHTML = '';

  trans.items.forEach(barang => {
    const row = document.createElement('div');
    row.className = 'flex justify-between border-b pb-1';
    row.innerHTML = `
      <span>${barang.nama}</span>
      <span>${barang.qty} x Rp ${formatRupiah(barang.harga)}</span>
    `;
    isi.appendChild(row);
  });

  document.getElementById("modalDetailTransaksi").classList.remove("hidden");
}

function tutupModalDetail() {
  document.getElementById("modalDetailTransaksi").classList.add("hidden");
}


        let dataKulakan = [];

document.getElementById('formKulakan').addEventListener('submit', handleSubmitKulakan);

async function handleSubmitKulakan(e) {
  e.preventDefault();
  console.log("üõ†Ô∏è Fungsi handleSubmitKulakan dijalankan!");

  const nama = document.getElementById('kulakanNama').value.trim();
  const supplier = document.getElementById('kulakanSupplier').value.trim() || '-';
  const barcode = document.getElementById('kulakanBarcode').value.trim();
  const kategori = document.getElementById('kulakanKategori').value.trim() || '-';

  const qtyVal = document.getElementById('kulakanQty').value.trim();
  const qty = qtyVal === "" ? 0 : parseInt(qtyVal);

  const satuan = document.getElementById('kulakanSatuan').value;
  const hargaKulakan = parseInt(document.getElementById('kulakanHargaKulakan').value);

  const hargaUmumPcs = parseInt(document.getElementById('kulakanHargaUmumPcs').value) || 0;
  const hargaUmumDus = parseInt(document.getElementById('kulakanHargaUmumDus').value) || 0;
  const hargaUmumRenteng = parseInt(document.getElementById('kulakanHargaUmumRenteng').value) || 0;
  const hargaGrosirPcs = parseInt(document.getElementById('kulakanHargaGrosirPcs').value) || 0;
  const hargaGrosirDus = parseInt(document.getElementById('kulakanHargaGrosirDus').value) || 0;
  const hargaGrosirRenteng = parseInt(document.getElementById('kulakanHargaGrosirRenteng').value) || 0;

  const konversiDus = parseInt(document.getElementById('kulakanKonversiDus').value) || 1;
  const konversiRenteng = parseInt(document.getElementById('kulakanKonversiRenteng').value) || 1;
  const tanggal = new Date().toLocaleString('id-ID');

  let jumlahPcs = qty;
  if (satuan === 'dus') jumlahPcs *= konversiDus;
  if (satuan === 'renteng') jumlahPcs *= konversiRenteng;

  const produkRef = ref(db, 'produk');
  const snapshot = await get(produkRef);
  let produkKey = null;
  let produkLama = null;

  if (snapshot.exists()) {
    snapshot.forEach(child => {
      const data = child.val();
      if (data.nama === nama || (barcode && data.barcode === barcode)) {
        produkKey = child.key;
        produkLama = data;
      }
    });
  }

  const hargaBaru = {
    umum: {
      pcs: hargaUmumPcs,
      dus: hargaUmumDus,
      renteng: hargaUmumRenteng
    },
    grosir: {
      pcs: hargaGrosirPcs,
      dus: hargaGrosirDus,
      renteng: hargaGrosirRenteng
    }
  };

  if (produkKey) {
    const stokBaru = (produkLama.stok || 0) + jumlahPcs;
    const dataBaru = {
      ...produkLama,
      stok: stokBaru,
      konversiDus,
      konversiRenteng,
      harga: hargaBaru
    };
    await set(ref(db, 'produk/' + produkKey), dataBaru);
  } else {
    const newRef = push(ref(db, 'produk'));
    await set(newRef, {
      id: newRef.key,
      nama,
      barcode,
      kategori,
      stok: jumlahPcs,
      konversiDus,
      konversiRenteng,
      harga: hargaBaru
    });
  }

  await push(ref(db, 'kulakan'), {
    namaProduk: nama,
    supplier,
    barcode,
    kategori,
    qty,
    satuan,
    harga: hargaKulakan,
    total: qty * hargaKulakan || 0,
    tanggal
  });

  e.target.reset();
  showNotification("Kulakan berhasil disimpan & produk diperbarui!", "success");
  ambilProdukDariFirebase?.();
  renderKulakan?.();
}



function renderKulakanTerfilter(data) {
  const tbody = document.getElementById("kulakanTable");
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400 py-4">Tidak ada data</td></tr>`;
    return;
  }

  data.forEach(item => {
    tbody.innerHTML += `
      <tr>
        <td>${item.tanggal || '-'}</td>
        <td>${item.namaProduk || '-'}</td>
        <td>${item.supplier || '-'}</td>
        <td>${item.qty || 0}</td>
        <td>Rp ${formatRupiah(item.harga || 0)}</td>
        <td>Rp ${formatRupiah(item.total || 0)}</td>
      </tr>
    `;
  });
}

let dataCasbon = [];

async function simpanCasbon(transaksi, pelanggan) {
  const data = {
    tanggal: new Date().toLocaleDateString('id-ID'),
    pelanggan: pelanggan?.namaToko || 'Tidak Diketahui',
    total: transaksi.total,
    sisa: transaksi.total,
    status: 'Belum Lunas'
  };

  try {
    const refCasbon = push(ref(db, 'casbon'));
    await set(refCasbon, data);
    showNotification('Data casbon berhasil disimpan ke Firebase!', 'success');
    ambilCasbonDariFirebase(); // ‚úÖ Refresh data (kalau kamu buat ini)
  } catch (error) {
    console.error(error);
    showNotification('Gagal menyimpan casbon.', 'error');
  }
}



function renderCasbon() {
  const tbody = document.getElementById("casbonTable");
  tbody.innerHTML = '';

  if (dataCasbon.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400 py-6">Belum ada data casbon</td></tr>`;
    return;
  }

  dataCasbon.forEach(item => {
    const row = `
      <tr>
        <td>${item.tanggal}</td>
        <td>${item.pelanggan}</td>
        <td>Rp ${formatRupiah(item.total)}</td>
        <td>Rp ${formatRupiah(item.sisa)}</td>
        <td class="text-center">
          <span class="px-2 py-1 rounded-full text-xs font-semibold ${item.status === 'lunas' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
            ${item.status.toUpperCase()}
          </span>
        </td>
        <td class="text-center">
          <button onclick="editCasbon('${item.key}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
        </td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}

// Scanner untuk Input Barcode di Form Produk
function scanBarcodeProduk() {
  barcodeDetected = false;
  document.getElementById("modalScanner").classList.remove("hidden");
  const scannerElement = document.getElementById("scanner");
  scannerElement.innerHTML = '';
  Quagga.offDetected();

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: scannerElement,
      constraints: {
        facingMode: "environment",
        width: { ideal: 640 },
        height: { ideal: 480 }
      }
    },
    locator: {
      patchSize: "medium",
      halfSample: false
    },
    decoder: {
      readers: ["ean_reader"]
    },
    locate: true
  }, function (err) {
    if (err) {
      console.error("‚ùå ERROR saat buka kamera:", err);
      showNotification("‚ùå Gagal membuka kamera: " + (err.name || err.message), "error");

      // Penjelasan interaktif
      if (err.name === "NotAllowedError") {
        alert("‚ö†Ô∏è Izin kamera ditolak. Silakan izinkan akses kamera.");
      } else if (err.name === "NotFoundError") {
        alert("üìµ Kamera tidak ditemukan. Coba perangkat lain.");
      }

      return;
    }

    Quagga.start();
    showNotification("‚úÖ Kamera aktif. Arahkan ke barcode.", "success");
  });

  Quagga.onDetected(function (result) {
    if (barcodeDetected) return;
    barcodeDetected = true;

    const code = result.codeResult.code;
    playBeep();
    document.getElementById("barcodeProduk").value = code;
    showNotification("‚úÖ Barcode berhasil dipindai!", "success");

    Quagga.stop();
    document.getElementById("modalScanner").classList.add("hidden");
  });
}


let barcodeDetected = false;

Quagga.onDetected(function (result) {
  if (barcodeDetected) return; // abaikan jika sudah scan
  barcodeDetected = true;

  const code = result.codeResult.code;
  playBeep();
  document.getElementById("barcodeProduk").value = code;
  showNotification("‚úÖ Barcode berhasil dipindai!", "success");

  Quagga.stop();
  document.getElementById("modalScanner").classList.add("hidden");
});

function closeScanner() {
  try {
    Quagga.stop();
  } catch (e) {}
  document.getElementById("modalScanner").classList.add("hidden");
}
function playBeep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = ctx.createOscillator();
  const gainNode = ctx.createGain();

  oscillator.type = 'square'; // jenis nada (square = khas mesin)
  oscillator.frequency.setValueAtTime(1000, ctx.currentTime); // nada (Hz)
  oscillator.connect(gainNode);
  gainNode.connect(ctx.destination);

  gainNode.gain.setValueAtTime(0.2, ctx.currentTime); // volume
  oscillator.start();
  oscillator.stop(ctx.currentTime + 0.15); // durasi 150ms
}

function tampilkanStruk(transaksi, pelanggan, bayar, kembalian) {
  const container = document.getElementById('strukIsi');
  const tanggalObj = new Date(transaksi.tanggal);
  const tanggal = tanggalObj.toLocaleDateString('id-ID');
  const jam = tanggalObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

  let isi = `
<pre style="font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4;">

${tanggal.padEnd(20)}${pelanggan.namaToko}
${jam}
------------------------------------------`;

  transaksi.items.forEach(item => {
    const qty = Number(item.qty) || 0;
    const harga = Number(item.hargaSatuan) || 0;
    const subtotal = qty * harga;

    isi += `
${item.nama.toUpperCase()}
${String(qty)} x ${formatRupiah(harga).padEnd(10)}${'Rp'.padEnd(3)}${formatRupiah(subtotal).padStart(10)}`;
  });

  isi += `
------------------------------------------
Total        ${'Rp'.padEnd(3)}${formatRupiah(transaksi.total).padStart(10)}
Bayar (Cash) ${'Rp'.padEnd(3)}${formatRupiah(bayar).padStart(10)}
Kembali      ${'Rp'.padEnd(3)}${formatRupiah(kembalian).padStart(10)}
------------------------------------------

         Terimakasih sudah berbelanja
               di toko kami
         
</pre>`;

  container.innerHTML = isi;
  document.getElementById('modalStruk').classList.remove('hidden');
  document.getElementById('strukButtons').classList.remove('hidden');
}
        
function cetakRawBT(transaksi) {
  let struk = '';
  struk += ' TOKO POJOK BAHRIYAH\n';
  struk += 'Jl. Simpang Tiga Partellon\n';
  struk += '-------------------------------\n';

  transaksi.items.forEach(item => {
    const nama = item.nama.slice(0, 16).padEnd(16); // max 16 karakter nama
    const qty = `x${item.qty}`.padEnd(4);
    const harga = `Rp${item.subtotal.toLocaleString('id-ID')}`;
    struk += `${nama}${qty}${harga}\n`;
  });

  struk += '-------------------------------\n';
  struk += `TOTAL : Rp${transaksi.total.toLocaleString('id-ID')}\n`;
  struk += 'Terima kasih!\n';

  // üîß Tambahkan feed sedikit saja
  struk += '\n\n\n';

  // üîß (Opsional) Tambahkan perintah cut ESC/POS:
  struk += String.fromCharCode(29) + 'V' + String.fromCharCode(1); // Cut jika printer mendukung

  const rawbtUrl = 'rawbt:print?text=' + encodeURIComponent(struk);
  window.location.href = rawbtUrl;
}
        
function cetakStrukQZ(transaksi) {
  const struk = `
TOKO POJOK BAHRIYAH
Jl. Simpang Tiga Partellon
-----------------------------
${transaksi.items.map(item => 
  `${item.nama} x${item.qty} Rp${item.subtotal.toLocaleString('id-ID')}`
).join('\n')}
-----------------------------
TOTAL : Rp${transaksi.total.toLocaleString('id-ID')}
Terima kasih!\n\n\n`;

  qz.websocket.connect().then(() => {
    return qz.printers.find(); // default printer
  }).then(printer => {
    const config = qz.configs.create(printer);
    const data = [{ type: 'raw', format: 'plain', data: struk }];
    return qz.print(config, data);
  }).then(() => {
    alert('Struk berhasil dicetak!');
    qz.websocket.disconnect();
  }).catch(err => {
    console.error(err);
    alert('Gagal cetak struk via QZ Tray.');
  });
}

function tutupStruk() {
  document.getElementById('modalStruk').classList.add('hidden');
}

        
        // Utility Functions
        function formatRupiah(angka) {
            return new Intl.NumberFormat('id-ID').format(angka);
        }

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
